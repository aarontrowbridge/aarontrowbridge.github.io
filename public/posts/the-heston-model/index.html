<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>the Heston stochastic volatility model | Aaron Trowbridge</title>
<meta name=keywords content="mathematical finance,stochastic processes,optimization,numerical methods">
<meta name=description content="an overview of a relatively modern and sophisticated model for pricing financial derivatives">
<meta name=author content>
<link rel=canonical href=https://aarontrowbridge.github.io/posts/the-heston-model/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.49c34b4b657358eeed1bdcae0ae7521b7d56c54efbe06e37c40b9f313dc02891.css integrity="sha256-ScNLS2VzWO7tG9yuCudSG31WxU774G43xAufMT3AKJE=" rel="preload stylesheet" as=style>
<link rel=icon href=https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="the Heston stochastic volatility model">
<meta property="og:description" content="an overview of a relatively modern and sophisticated model for pricing financial derivatives">
<meta property="og:type" content="article">
<meta property="og:url" content="https://aarontrowbridge.github.io/posts/the-heston-model/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-01T10:17:17-05:00">
<meta property="article:modified_time" content="2021-08-01T10:17:17-05:00"><meta property="og:site_name" content="Aaron Trowbridge">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="the Heston stochastic volatility model">
<meta name=twitter:description content="an overview of a relatively modern and sophisticated model for pricing financial derivatives">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://aarontrowbridge.github.io/posts/"},{"@type":"ListItem","position":2,"name":"the Heston stochastic volatility model","item":"https://aarontrowbridge.github.io/posts/the-heston-model/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"the Heston stochastic volatility model","name":"the Heston stochastic volatility model","description":"an overview of a relatively modern and sophisticated model for pricing financial derivatives","keywords":["mathematical finance","stochastic processes","optimization","numerical methods"],"articleBody":"The development of mathematical finance, much like the processes it aims to study, has had a particularly jumpy history. A major leap came in 1973, when the Black-Scholes option pricing model  was published and mathematically understood. The essential idea is to model the underlying asset $S_t$ of an option as a geometric brownian motion, with a stochastic differential equation (SDE), given by\n$$ dS_t = \\mu S_t \\ dt + \\sigma S_t \\ dW_t, $$\nwhich contains a drift parameter $\\mu$ and a constant volatility parameter $\\sigma$. Taking the price of an option at time $t$ to be a function $C(S,t)$, Ito’s lemma  applies and the famous Black-Scholes formula can be derived.\nThe first solved stochastic volatility model appeared in 1993, due to Steven Heston1, which aimed to correct the shortcomings of the Black-Scholes model and is what will be studied here.\nThe Heston Model This model is essentially the same as the Black-Scholes model, except that on top of modelling the underlying asset $S$ as a stochastic process, the volatility parameter is also modelled as a stochastic process. In terms of SDEs\n$$ \\begin{align*} dS_t \u0026= \\mu S_t \\ dt + \\sqrt{v_t} S_t \\ dW_t^{(1)}, \\\\\\ dv_t \u0026= \\kappa(\\bar{v} - v_t) \\ dt + \\sigma \\sqrt{v_t} \\ dW_t^{(2)}, \\\\\\ \\end{align*} $$\nwith\n$$ dW_t^{(1)}dW_t^{(2)} = \\rho dt. $$\nThe five parameters of the model:\n $v_0$, the initial volatility $\\bar{v}$, the long variance $\\rho$, the correlation of the two Wiener processes $\\kappa$, the rate at which $v_t$ reverts to $\\bar{v}$ $\\sigma$, the volatility of the volatility  We will use $\\mathbf{\\theta} = [v_0, \\bar{v}, \\rho, \\kappa, \\sigma]^\\top$ to represent the vector of parameters of the model.\nPricing Derivatives For a vanilla call option with strike $K$ and maturity $T$, where the underlying asset has a spot price $S_0$ and interest rate $r$, we can use our model to estimate the price:\n$$ \\begin{align*} C(\\mathbf{\\theta}; K, T) \u0026= e^{-rT} \\mathbb{E} \\left[\\left( S_T - K \\right)1_{{S_T \\geq K } }(S_T) \\right] \\\\\\ \u0026= e^{-rT} \\left( \\mathbb{E} \\left[ S_T \\ 1_{{S_T \\geq K }}(S_T)\\right] - K \\mathbb{E} \\left[ 1_{{S_T \\geq K }}(S_T)\\right] \\right) \\\\\\ \u0026= S_0 P_1 - e^{-rT}K P_2 \\\\\\ \\end{align*} $$\nHere $P_1$ and $P_2$ are given as\n$$ \\begin{align*} P_1 \u0026= \\frac{1}{2} + \\frac{1}{\\pi}\\int_0^{\\infty} \\operatorname{Re} \\left( \\frac{e^{-iu \\log K}}{iuF} \\varphi(\\theta; u - i, T) \\right) \\mathrm{d}u, \\\\\\ P_2 \u0026= \\frac{1}{2} + \\frac{1}{\\pi}\\int_0^{\\infty} \\operatorname{Re} \\left( \\frac{e^{-iu \\log K}}{iu} \\varphi(\\theta; u, T) \\right) \\mathrm{d}u, \\\\\\ \\end{align*} $$\nwith $F = S_0 e^{rT}$ and $\\varphi(\\theta; u, t)$ is the characteristic function of the logarithm of the stock price model.\nThe characteristic function was given in its original form by Heston and subsequently in other forms that tried to avoid discontinuities and be analytically differentiable. The representation that achieved both of these goals was given by Cui et al.2 in 2016. It is given by\n$$ \\varphi(\\theta; u, t) = \\exp \\left\\{ iu \\left( \\log S_0 + rt - \\frac{t \\kappa \\bar{v} \\rho}{\\sigma} \\right) - v_0 A + \\frac{2 \\kappa \\bar{v}}{\\sigma^2} D\\right\\} $$\nwhere\n$$ \\begin{align} A \u0026:= \\frac{A_1}{A_2}, \\\\\\ A_1 \u0026:= (u^2 + iu)\\sinh \\frac{dt}{2}, \\\\\\ A_2 \u0026:= d \\cosh \\frac{dt}{2} + \\xi \\sinh \\frac{dt}{2}, \\\\\\ \\end{align} $$\nand\n$$ D := \\log d + \\frac{(\\kappa - d)t}{2} - \\log \\left( \\frac{d + \\xi}{2} + \\frac{d - \\xi}{2}e^{-dt}\\right), $$\nwith\n$$ \\begin{align} d \u0026:= \\sqrt{\\xi^2 + \\sigma^2(u^2 + iu)}, \\\\\\ \\xi \u0026:= \\kappa - i \\sigma \\rho u, \\\\\\ \\end{align} $$\nCalibrating The Model In order to calibrate the parameters of our model to the observed market data we will seek to minimize the difference between the market price of a vanilla call option $C^*(K_i, T_i)$ and our model’s prediction $C(\\theta; K_i, T_i)$ for various strikes and maturities, $K_i$ and $T_i$ respectively. We compute a residual vector $\\mathbf{r}(\\theta) \\in \\mathbb{R}^n$ for the $n$ options, with $i$th component\n$$ r_i(\\theta) := C(\\theta; K_i, T_i) - C^*(K_i, T_i), \\qquad i = 1,\\dots,n. $$\nThe optimization problem can then be stated as nonlinear least squares problem\n$$ \\min_{\\theta \\in \\mathbb{R}^m}f(\\theta). $$\nWhere $m = 5$, in this case, is the dimesion of the parameter vector and\n$$ f(\\theta) := \\frac{1}{2} |\\mathbf{r}(\\theta)|^2 = \\frac{1}{2} \\mathbf{r}^\\top(\\theta)\\mathbf{r}(\\theta). $$\nHere we have $n \\gg m$ so the optimization problem is overdetermined but there is significant computational cost involved in evaluating $C(\\theta; K, T)$. Additionally an analytic expression for the gradient was not known until just recently, also given by Cui et al.\nAnalytic Gradient We use $\\nabla = \\partial / \\partial \\theta$ as the gradient operator with respect to the parameter vector $\\theta$ and $\\nabla \\nabla^\\top$ for the Hessian operator. We are interested in calculating the gradient and Hessian of the objective function $f(\\theta)$:\n$$ \\begin{align} \\nabla f \u0026= \\nabla \\left( \\frac{1}{2} \\mathbf{r}^\\top \\mathbf{r} \\right) \\\\\\ \u0026= \\nabla \\mathbf{r}^\\top \\mathbf{r} \\\\\\ \u0026= \\mathbf{J} \\mathbf{r} \\\\\\ \\end{align} $$\nwhere $\\mathbf{J} := \\nabla \\mathbf{r}^\\top$ is the Jacobian matrix of the residual vector $\\mathbf{r}$ which has elements\n$$ J_{ij} = \\frac{\\partial r_j}{\\partial \\theta_i}. $$\nThe Hessian of the objective function is then\n$$ \\begin{align*} \\nabla \\nabla^\\top f \u0026= \\nabla \\nabla^\\top \\left( \\frac{1}{2} \\mathbf{r}^\\top \\mathbf{r} \\right) \\\\\\ \u0026= \\nabla \\left(\\nabla \\mathbf{r}^\\top \\mathbf{r} \\right)^\\top \\\\\\ \u0026= \\nabla \\left( \\mathbf{r}^\\top \\left( \\nabla \\mathbf{r}^\\top \\right)^\\top \\right) \\\\\\ \u0026= \\nabla \\mathbf{r}^\\top \\left( \\nabla \\mathbf{r}^\\top \\right)^\\top + \\sum_i r_i \\nabla \\nabla^\\top r_i \\\\\\ \u0026= \\mathbf{J}\\mathbf{J}^\\top + \\sum_i r_i \\mathbf{H}(r_i) \\\\\\ \\end{align*} $$\nwhere $\\mathbf{H}(r_i) := \\nabla \\nabla^\\top r_i$ is the Hessian matrix for each residual $r_i$ with components\n$$ H_{jk}(r_i) = \\frac{\\partial^2r_i}{\\partial \\theta_j \\partial \\theta_k}. $$\nFor details of the calculation of $\\nabla C(\\theta; K, T)$ needed in the implementation of the optimization algorithm described below see Theorem 1 in the paper by Cui et al. As can be inferred from the form of the characteristic function it is not clean!\nThe Levenberg-Marquardt Method The LM algorithm  aims to solve the problem of minimizing the squared residuals of the model. We wish to find\n$$ \\hat\\theta \\in \\arg\\min_{\\theta} f(\\theta). $$\nHere, $\\hat\\theta$ is not necessarily a global minimum (though we hope to show it is), which is why the member notation is used in place of equality.\nThe derivation of the parameter space search step goes as follows:\n$$ \\begin{align*} f(\\theta + \\Delta \\theta) \u0026\\approx f(\\theta) + \\Delta \\theta^\\top \\nabla f + \\frac{1}{2} \\Delta \\theta^\\top \\left(\\nabla \\nabla^\\top f \\right) \\Delta \\theta. \\\\\\ \u0026= f(\\theta) + \\Delta \\theta^\\top \\nabla f + \\frac{1}{2} \\Delta \\theta^\\top \\left(\\mathbf{J} \\mathbf{J}^\\top + \\sum_i r_i \\mathbf{H}(r_i) \\right)\\Delta \\theta. \\\\\\ \u0026\\approx f(\\theta) + \\Delta \\theta^\\top \\nabla f + \\frac{1}{2} \\Delta \\theta^\\top \\mathbf{J} \\mathbf{J}^\\top \\Delta \\theta. \\\\\\ % f(\\theta + \\Delta \\theta) \u0026= \\frac{1}{2}\\mathbf{r}(\\theta + \\Delta \\theta)^\\top \\mathbf{r}(\\theta + \\Delta \\theta) \\\\\\ % \u0026\\approx \\frac{1}{2} \\left( \\mathbf{r}(\\theta) + \\mathbf{J}^\\top \\Delta \\theta \\right)^\\top\\left( \\mathbf{r}(\\theta) + \\mathbf{J}^\\top \\Delta \\theta \\right) \\\\\\ % \u0026= \\frac{1}{2} \\left( \\mathbf{r}(\\theta)^\\top \\mathbf{r}(\\theta) + 2 \\mathbf{r}(\\theta)^\\top \\mathbf{J}^\\top \\Delta \\theta + \\Delta \\theta^\\top \\mathbf{J} \\mathbf{J}^\\top \\Delta \\theta \\right) \\\\\\ % \u0026= f(\\theta) + \\nabla f^\\top \\Delta \\theta + \\frac{1}{2} \\Delta \\theta^\\top \\mathbf{J} \\mathbf{J}^\\top \\Delta \\theta. \\\\\\ \\end{align*} $$\nWhere the last line is a valid approximation when the residuals $r_i$ or the Hessian of the residuals $\\mathbf{H}(r_i)$ are small.\nNow taking the derivative with respect to $\\Delta \\theta$, setting it equal to zero, and flipping the sign (to descend the space), we arrive at the search step:\n$$ \\Delta \\theta = \\left( \\mathbf{J}\\mathbf{J}^\\top + \\mu \\mathbf{I} \\right)^{-1} \\nabla f. $$\nHere the $\\mu \\mathbf{I}$ term is Levenberg’s contribution, and acts as a damping factor that is dynamically adjusted to interpolate between the method of steepest descent and the Gauss-Newton method  .\nWhen the residuals are large (the model is far from the optimum), $\\mu$ is set large, resulting in a steepest descent approach. When close to the optimum, $\\mu$ is made small, resulting in the Gauss-Newton method.\nFor details of the LM calibration algorithm see Algorithm 4.1 in Cui et al.2 Implementation and Results A incomplete repository of code can be found at my github in LevyProcesses  . I will be following up with a new post when I have a working model.\nReferences   Heston (1993) “Closed-Form Solution for Options with Stochastic Volatility with Applications to Bond and Currency Options” pdf  ↩︎\n Cui et al. (2015) “Full and fast calibration of the Heston stochastic volatility model” arxiv:1511.08718  ↩︎\n   ","wordCount":"1360","inLanguage":"en","datePublished":"2021-08-01T10:17:17-05:00","dateModified":"2021-08-01T10:17:17-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://aarontrowbridge.github.io/posts/the-heston-model/"},"publisher":{"@type":"Organization","name":"Aaron Trowbridge","logo":{"@type":"ImageObject","url":"https://aarontrowbridge.github.io/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://aarontrowbridge.github.io/ accesskey=h title="Aaron Trowbridge (Alt + H)">Aaron Trowbridge</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://aarontrowbridge.github.io/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://aarontrowbridge.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://aarontrowbridge.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://aarontrowbridge.github.io/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://aarontrowbridge.github.io/notes/ title=Notes>
<span>Notes</span>
</a>
</li>
<li>
<a href=https://aarontrowbridge.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://aarontrowbridge.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://aarontrowbridge.github.io/posts/>Posts</a></div>
<h1 class=post-title>
the Heston stochastic volatility model
</h1>
<div class=post-description>
an overview of a relatively modern and sophisticated model for pricing financial derivatives
</div>
<div class=post-meta><span title="2021-08-01 10:17:17 -0500 -0500">August 1, 2021</span>&nbsp;·&nbsp;7 min&nbsp;|&nbsp;<a href=https://github.com/aarontrowbridge/aarontrowbridge.github.io/content/posts/4-the-heston-model.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#the-heston-model aria-label="The Heston Model">The Heston Model</a></li>
<li>
<a href=#pricing-derivatives aria-label="Pricing Derivatives">Pricing Derivatives</a></li>
<li>
<a href=#calibrating-the-model aria-label="Calibrating The Model">Calibrating The Model</a><ul>
<li>
<a href=#analytic-gradient aria-label="Analytic Gradient">Analytic Gradient</a></li>
<li>
<a href=#the-levenberg-marquardt-method aria-label="The Levenberg-Marquardt Method">The Levenberg-Marquardt Method</a></li></ul>
</li>
<li>
<a href=#implementation-and-results aria-label="Implementation and Results">Implementation and Results</a></li>
<li>
<a href=#references aria-label=References>References</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>The development of mathematical finance, much like the processes it aims to study, has had a particularly jumpy history. A major leap came in 1973, when the
<a href=https://en.wikipedia.org/wiki/Black-Scholes_model target=_blank>
Black-Scholes option pricing model
</a>
was published and mathematically understood. The essential idea is to model the underlying asset $S_t$ of an option as a geometric brownian motion, with a stochastic differential equation (SDE), given by</p>
<p>$$
dS_t = \mu S_t \ dt + \sigma S_t \ dW_t,
$$</p>
<p>which contains a drift parameter $\mu$ and a <em>constant</em> volatility parameter $\sigma$. Taking the price of an option at time $t$ to be a function $C(S,t)$,
<a href=https://en.wikipedia.org/wiki/It%C3%B4%27s_lemma target=_blank>
Ito&rsquo;s lemma
</a>
applies and the famous Black-Scholes formula can be derived.</p>
<p>The first solved stochastic volatility model appeared in 1993, due to Steven Heston<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, which aimed to correct the shortcomings of the Black-Scholes model and is what will be studied here.</p>
<h2 id=the-heston-model>The Heston Model<a hidden class=anchor aria-hidden=true href=#the-heston-model>#</a></h2>
<p>This model is essentially the same as the Black-Scholes model, except that on top of modelling the underlying asset $S$ as a stochastic process, the volatility parameter is also modelled as a stochastic process. In terms of SDEs</p>
<p>$$
\begin{align*}
dS_t &= \mu S_t \ dt + \sqrt{v_t} S_t \ dW_t^{(1)}, \\\
dv_t &= \kappa(\bar{v} - v_t) \ dt + \sigma \sqrt{v_t} \ dW_t^{(2)}, \\\
\end{align*}
$$</p>
<p>with</p>
<p>$$
dW_t^{(1)}dW_t^{(2)} = \rho dt.
$$</p>
<p>The five parameters of the model:</p>
<ul>
<li>$v_0$, the initial volatility</li>
<li>$\bar{v}$, the long variance</li>
<li>$\rho$, the correlation of the two Wiener processes</li>
<li>$\kappa$, the rate at which $v_t$ reverts to $\bar{v}$</li>
<li>$\sigma$, the volatility of the volatility</li>
</ul>
<p>We will use $\mathbf{\theta} = [v_0, \bar{v}, \rho, \kappa, \sigma]^\top$ to represent the vector of parameters of the model.</p>
<h2 id=pricing-derivatives>Pricing Derivatives<a hidden class=anchor aria-hidden=true href=#pricing-derivatives>#</a></h2>
<p>For a vanilla call option with strike $K$ and maturity $T$, where the underlying asset has a spot price $S_0$ and interest rate $r$, we can use our model to estimate the price:</p>
<p>$$
\begin{align*}
C(\mathbf{\theta}; K, T) &= e^{-rT} \mathbb{E} \left[\left( S_T - K \right)1_{{S_T \geq K } }(S_T) \right] \\\
&= e^{-rT} \left( \mathbb{E} \left[ S_T \ 1_{{S_T \geq K }}(S_T)\right] - K \mathbb{E} \left[ 1_{{S_T \geq K }}(S_T)\right] \right) \\\
&= S_0 P_1 - e^{-rT}K P_2 \\\
\end{align*}
$$</p>
<p>Here $P_1$ and $P_2$ are given as</p>
<p>$$
\begin{align*}
P_1 &= \frac{1}{2} + \frac{1}{\pi}\int_0^{\infty} \operatorname{Re} \left( \frac{e^{-iu \log K}}{iuF} \varphi(\theta; u - i, T) \right) \mathrm{d}u, \\\
P_2 &= \frac{1}{2} + \frac{1}{\pi}\int_0^{\infty} \operatorname{Re} \left( \frac{e^{-iu \log K}}{iu} \varphi(\theta; u, T) \right) \mathrm{d}u, \\\
\end{align*}
$$</p>
<p>with $F = S_0 e^{rT}$ and $\varphi(\theta; u, t)$ is the characteristic function of the logarithm of the stock price model.</p>
<p>The characteristic function was given in its original form by Heston and subsequently in other forms that tried to avoid discontinuities and be analytically differentiable. The representation that achieved both of these goals was given by Cui et al.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> in 2016. It is given by</p>
<p>$$
\varphi(\theta; u, t) = \exp \left\{ iu \left( \log S_0 + rt - \frac{t \kappa \bar{v} \rho}{\sigma} \right) - v_0 A + \frac{2 \kappa \bar{v}}{\sigma^2} D\right\}
$$</p>
<p>where</p>
<p>$$
\begin{align}
A &:= \frac{A_1}{A_2}, \\\
A_1 &:= (u^2 + iu)\sinh \frac{dt}{2}, \\\
A_2 &:= d \cosh \frac{dt}{2} + \xi \sinh \frac{dt}{2}, \\\
\end{align}
$$</p>
<p>and</p>
<p>$$
D := \log d + \frac{(\kappa - d)t}{2} - \log \left( \frac{d + \xi}{2} + \frac{d - \xi}{2}e^{-dt}\right),
$$</p>
<p>with</p>
<p>$$
\begin{align}
d &:= \sqrt{\xi^2 + \sigma^2(u^2 + iu)}, \\\
\xi &:= \kappa - i \sigma \rho u, \\\
\end{align}
$$</p>
<h2 id=calibrating-the-model>Calibrating The Model<a hidden class=anchor aria-hidden=true href=#calibrating-the-model>#</a></h2>
<p>In order to calibrate the parameters of our model to the observed market data we will seek to minimize the difference between the market price of a vanilla call option $C^*(K_i, T_i)$ and our model&rsquo;s prediction $C(\theta; K_i, T_i)$ for various strikes and maturities, $K_i$ and $T_i$ respectively. We compute a residual vector $\mathbf{r}(\theta) \in \mathbb{R}^n$ for the $n$ options, with $i$th component</p>
<p>$$
r_i(\theta) := C(\theta; K_i, T_i) - C^*(K_i, T_i), \qquad i = 1,\dots,n.
$$</p>
<p>The optimization problem can then be stated as nonlinear least squares problem</p>
<p>$$
\min_{\theta \in \mathbb{R}^m}f(\theta).
$$</p>
<p>Where $m = 5$, in this case, is the dimesion of the parameter vector and</p>
<p>$$
f(\theta) := \frac{1}{2} |\mathbf{r}(\theta)|^2 = \frac{1}{2} \mathbf{r}^\top(\theta)\mathbf{r}(\theta).
$$</p>
<p>Here we have $n \gg m$ so the optimization problem is overdetermined but there is significant computational cost involved in evaluating $C(\theta; K, T)$. Additionally an analytic expression for the gradient was not known until just recently, also given by Cui et al.</p>
<h3 id=analytic-gradient>Analytic Gradient<a hidden class=anchor aria-hidden=true href=#analytic-gradient>#</a></h3>
<p>We use $\nabla = \partial / \partial \theta$ as the gradient operator with respect to the parameter vector $\theta$ and $\nabla \nabla^\top$ for the Hessian operator. We are interested in calculating the gradient and Hessian of the objective function $f(\theta)$:</p>
<p>$$
\begin{align}
\nabla f &= \nabla \left( \frac{1}{2} \mathbf{r}^\top \mathbf{r} \right) \\\
&= \nabla \mathbf{r}^\top \mathbf{r} \\\
&= \mathbf{J} \mathbf{r} \\\
\end{align}
$$</p>
<p>where $\mathbf{J} := \nabla \mathbf{r}^\top$ is the Jacobian matrix of the residual vector $\mathbf{r}$ which has elements</p>
<p>$$
J_{ij} = \frac{\partial r_j}{\partial \theta_i}.
$$</p>
<p>The Hessian of the objective function is then</p>
<p>$$
\begin{align*}
\nabla \nabla^\top f &= \nabla \nabla^\top \left( \frac{1}{2} \mathbf{r}^\top \mathbf{r} \right) \\\
&= \nabla \left(\nabla \mathbf{r}^\top \mathbf{r} \right)^\top \\\
&= \nabla \left( \mathbf{r}^\top \left( \nabla \mathbf{r}^\top \right)^\top \right) \\\
&= \nabla \mathbf{r}^\top \left( \nabla \mathbf{r}^\top \right)^\top + \sum_i r_i \nabla \nabla^\top r_i \\\
&= \mathbf{J}\mathbf{J}^\top + \sum_i r_i \mathbf{H}(r_i) \\\
\end{align*}
$$</p>
<p>where $\mathbf{H}(r_i) := \nabla \nabla^\top r_i$ is the Hessian matrix for each residual $r_i$ with components</p>
<p>$$
H_{jk}(r_i) = \frac{\partial^2r_i}{\partial \theta_j \partial \theta_k}.
$$</p>
<p>For details of the calculation of $\nabla C(\theta; K, T)$ needed in the implementation of the optimization algorithm described below see Theorem 1 in the paper by Cui et al. As can be inferred from the form of the characteristic function it is not clean!</p>
<h3 id=the-levenberg-marquardt-method>The Levenberg-Marquardt Method<a hidden class=anchor aria-hidden=true href=#the-levenberg-marquardt-method>#</a></h3>
<p>The
<a href=https://en.wikipedia.org/wiki/Levenberg-Marquardt_algorithm target=_blank>
LM algorithm
</a>
aims to solve the problem of minimizing the squared residuals of the model. We wish to find</p>
<p>$$
\hat\theta \in \arg\min_{\theta} f(\theta).
$$</p>
<p>Here, $\hat\theta$ is not necessarily a <em>global</em> minimum (though we hope to show it is), which is why the member notation is used in place of equality.</p>
<p>The derivation of the parameter space search step goes as follows:</p>
<p>$$
\begin{align*}
f(\theta + \Delta \theta) &\approx f(\theta) + \Delta \theta^\top \nabla f + \frac{1}{2} \Delta \theta^\top \left(\nabla \nabla^\top f \right) \Delta \theta. \\\
&= f(\theta) + \Delta \theta^\top \nabla f + \frac{1}{2} \Delta \theta^\top \left(\mathbf{J} \mathbf{J}^\top + \sum_i r_i \mathbf{H}(r_i) \right)\Delta \theta. \\\
&\approx f(\theta) + \Delta \theta^\top \nabla f + \frac{1}{2} \Delta \theta^\top \mathbf{J} \mathbf{J}^\top \Delta \theta. \\\
% f(\theta + \Delta \theta) &= \frac{1}{2}\mathbf{r}(\theta + \Delta \theta)^\top \mathbf{r}(\theta + \Delta \theta) \\\
% &\approx \frac{1}{2} \left( \mathbf{r}(\theta) + \mathbf{J}^\top \Delta \theta \right)^\top\left( \mathbf{r}(\theta) + \mathbf{J}^\top \Delta \theta \right) \\\
% &= \frac{1}{2} \left( \mathbf{r}(\theta)^\top \mathbf{r}(\theta) + 2 \mathbf{r}(\theta)^\top \mathbf{J}^\top \Delta \theta + \Delta \theta^\top \mathbf{J} \mathbf{J}^\top \Delta \theta \right) \\\
% &= f(\theta) + \nabla f^\top \Delta \theta + \frac{1}{2} \Delta \theta^\top \mathbf{J} \mathbf{J}^\top \Delta \theta. \\\
\end{align*}
$$</p>
<p>Where the last line is a valid approximation when the residuals $r_i$ or the Hessian of the residuals $\mathbf{H}(r_i)$ are small.</p>
<p>Now taking the derivative with respect to $\Delta \theta$, setting it equal to zero, and flipping the sign (to descend the space), we arrive at the search step:</p>
<p>$$
\Delta \theta = \left( \mathbf{J}\mathbf{J}^\top + \mu \mathbf{I} \right)^{-1} \nabla f.
$$</p>
<p>Here the $\mu \mathbf{I}$ term is Levenberg&rsquo;s contribution, and acts as a damping factor that is dynamically adjusted to interpolate between the method of steepest descent and the
<a href=https://en.wikipedia.org/wiki/Gauss-Newton_algorithm target=_blank>
Gauss-Newton method
</a>
.</p>
<p>When the residuals are large (the model is far from the optimum), $\mu$ is set large, resulting in a steepest descent approach. When close to the optimum, $\mu$ is made small, resulting in the Gauss-Newton method.</p>
<p>For details of the LM calibration algorithm see Algorithm 4.1 in Cui et al.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>
</p>
<h2 id=implementation-and-results>Implementation and Results<a hidden class=anchor aria-hidden=true href=#implementation-and-results>#</a></h2>
<p>A incomplete repository of code can be found at my github in
<a href=https://github.com/aarontrowbridge/LevyProcesses target=_blank>
LevyProcesses
</a>
. I will be following up with a new post when I have a working model.</p>
<h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Heston (1993) &ldquo;Closed-Form Solution for Options with Stochastic Volatility with Applications to Bond and Currency Options&rdquo;
<a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.139.3204&rep=rep1&type=pdf" target=_blank>
pdf
</a>
&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p>Cui et al. (2015) &ldquo;Full and fast calibration of the Heston stochastic volatility model&rdquo;
<a href=https://arxiv.org/abs/1511.08718v2 target=_blank>
arxiv:1511.08718
</a>
&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://aarontrowbridge.github.io/tags/mathematical-finance/>mathematical finance</a></li>
<li><a href=https://aarontrowbridge.github.io/tags/stochastic-processes/>stochastic processes</a></li>
<li><a href=https://aarontrowbridge.github.io/tags/optimization/>optimization</a></li>
<li><a href=https://aarontrowbridge.github.io/tags/numerical-methods/>numerical methods</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://aarontrowbridge.github.io/posts/central-identity-of-QFT/>
<span class=title>« Prev Page</span>
<br>
<span>the central identity of quantum field theory</span>
</a>
<a class=next href=https://aarontrowbridge.github.io/posts/pseudovectors/>
<span class=title>Next Page »</span>
<br>
<span>pseudovectors</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on twitter" href="https://twitter.com/intent/tweet/?text=the%20Heston%20stochastic%20volatility%20model&url=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f&hashtags=mathematicalfinance%2cstochasticprocesses%2coptimization%2cnumericalmethods"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f&title=the%20Heston%20stochastic%20volatility%20model&summary=the%20Heston%20stochastic%20volatility%20model&source=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on reddit" href="https://reddit.com/submit?url=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f&title=the%20Heston%20stochastic%20volatility%20model"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on whatsapp" href="https://api.whatsapp.com/send?text=the%20Heston%20stochastic%20volatility%20model%20-%20https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share the Heston stochastic volatility model on telegram" href="https://telegram.me/share/url?text=the%20Heston%20stochastic%20volatility%20model&url=https%3a%2f%2faarontrowbridge.github.io%2fposts%2fthe-heston-model%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=https://aarontrowbridge.github.io/>Aaron Trowbridge</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>